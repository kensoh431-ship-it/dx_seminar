<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地名から緯度・経度を取得</title>
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>

    <div class="container">
        <h2>座標取得ツール</h2>

        <label for="address">地名・住所を入力:</label>
        <input type="text" id="address" placeholder="例: 東京タワー">

        <button id="get-coords-btn">座標を取得する</button>

        <div class="result">
            <div><span class="label">緯度:</span> <span id="lat">---</span></div>
            <div><span class="label">経度:</span> <span id="lon">---</span></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
        $(function () {
            /**
             * jQueryの「$(function() { ... });」は、HTMLの読み込みが
             * 完了した後に実行されることを保証するおまじないです。
             */

            // ボタンクリック時のイベントを設定
            $('#get-coords-btn').on('click', function () {

                // 1. 入力値の取得
                // jQueryの val() メソッドで入力フォームの値を取得します
                const address = $('#address').val().trim();

                // 表示更新用に対象の要素をjQueryオブジェクトとして変数に格納
                const $latDiv = $('#lat');
                const $lonDiv = $('#lon');

                // 入力チェック
                if (!address) {
                    alert("地名を入力してください");
                    return;
                }

                // 状態の初期化
                $latDiv.text("取得中...");
                $lonDiv.text("取得中...");

                /**
                 * 2. jQueryのAjax機能を使用してAPIリクエストを送信
                 * fetchよりも古いブラウザへの対応が容易で、書き方も直感的です。
                 */
                $.ajax({
                    url: 'https://nominatim.openstreetmap.org/search',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        q: address,      // jQueryが自動でURLエンコードしてくれます
                        format: 'json',
                        limit: 1
                    },
                    headers: {
                        // 利用規約に基づくUser-Agentの設定
                        'User-Agent': 'MyGeocodingApp/1.0'
                    }
                })
                    .done(function (data) {
                        /**
                         * .done は通信成功時に呼ばれます。
                         * dataには既に解析済みのJSONオブジェクトが入っています。
                         */
                        if (data && data.length > 0) {
                            // データの表示（textメソッドで安全に書き換え）
                            $latDiv.text(data[0].lat);
                            $lonDiv.text(data[0].lon);
                        } else {
                            $latDiv.text("見つかりませんでした");
                            $lonDiv.text("見つかりませんでした");
                        }
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        /**
                         * .fail は通信失敗時やエラー時に呼ばれます。
                         */
                        console.error("エラー詳細:", textStatus, errorThrown);
                        alert("データの取得に失敗しました。");
                        $latDiv.text("エラー");
                        $lonDiv.text("エラー");
                    });
            });
        });
    </script>

</body>

</html>