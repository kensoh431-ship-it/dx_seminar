<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>天気予報取得ツール</title>
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>

    <h2>天気予報検索</h2>

    <div class="input-group">
        <label>緯度:</label>
        <input type="number" id="lat" step="0.01" value="35.6895">
    </div>
    <div class="input-group">
        <label>経度:</label>
        <input type="number" id="lng" step="0.01" value="139.6917">
    </div>
    <button id="btn-get-weather">天気表示</button>

    <div class="result-container">
        <div id="today-weather" class="weather-card">
            <div class="day-title">今日</div>
            <p>天気: <span id="t-condition">-</span></p>
            <p>最高: <span id="t-max">-</span>℃</p>
            <p>最低: <span id="t-min">-</span>℃</p>
        </div>

        <div id="tomorrow-weather" class="weather-card">
            <div class="day-title">明日</div>
            <p>天気: <span id="tm-condition">-</span></p>
            <p>最高: <span id="tm-max">-</span>℃</p>
            <p>最低: <span id="tm-min">-</span>℃</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
        /**
         * 1. ページ読み込み完了後に実行される処理 (jQueryの基本)
         * $(function() { ... }) は document.ready の短縮形です。
         */
        $(function () {

            // 天気コードを名称に変換する定数
            const WEATHER_MAP = {
                0: "快晴", 1: "晴れ", 2: "時々曇り", 3: "曇り",
                45: "霧", 48: "霧氷",
                51: "小雨", 53: "雨", 55: "強い雨",
                61: "小雨", 63: "雨", 65: "激しい雨",
                71: "小雪", 73: "雪", 75: "激しい雪",
                80: "にわか雨", 81: "雨", 82: "激しいにわか雨",
                95: "雷雨"
            };

            /**
             * 2. ボタンクリックイベントの設定
             * HTMLに onclick を書く代わりに、idに対してクリック時の動きを紐付けます。
             */
            $('#btn-get-weather').on('click', function () {
                getWeather();
            });

            /**
             * 3. APIから天気を取得する関数
             */
            function getWeather() {
                // jQueryの val() を使って入力値を取得
                const lat = $('#lat').val();
                const lng = $('#lng').val();
                const locName = $('#locationName').val() || "指定された場所";

                // APIのURL構築
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`;

                /**
                 * 4. jQuery.ajax() を使った非同期通信
                 * fetchより多機能で、古いブラウザの互換性も吸収してくれます。
                 */
                $.ajax({
                    url: url,
                    type: 'GET',
                    dataType: 'json',
                })
                    .done(function (data) {
                        // 通信成功時の処理
                        updateDisplay(locName, data);
                    })
                    .fail(function (error) {
                        // 通信失敗時の処理
                        console.error("データの取得に失敗しました:", error);
                        alert("データの取得に失敗しました。緯度・経度が正しいか確認してください。");
                    });
            }

            /**
             * 5. 画面表示を更新する関数
             * jQueryの text() メソッドを使って中身を書き換えます。
             */
            function updateDisplay(locName, data) {
                // 今日のデータ表示 (配列の0番目)
                const today = data.daily;
                $('#t-condition').text(WEATHER_MAP[today.weathercode[0]] || "不明");
                $('#t-max').text(today.temperature_2m_max[0]);
                $('#t-min').text(today.temperature_2m_min[0]);

                // 明日のデータ表示 (配列の1番目)
                $('#tm-condition').text(WEATHER_MAP[today.weathercode[1]] || "不明");
                $('#tm-max').text(today.temperature_2m_max[1]);
                $('#tm-min').text(today.temperature_2m_min[1]);
            }
        });
    </script>
</body>

</html>